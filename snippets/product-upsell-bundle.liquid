{% comment %}
  ⚠️ UPSELL ONLY SHOWS ON: Lettuce Wraps and Sauce Cookbook PDF
  Product URL: https://cookingwithkahnke.com/products/lettuce-wraps-and-sauce-cookbook-pdf
  Will NOT appear anywhere else on the site
{% endcomment %}

{% if product.handle == 'lettuce-wraps-and-sauce-cookbook-pdf' %}
  {%- comment -%} Get the original cookbook product by handle - try multiple possible handles {%- endcomment -%}
  {%- assign original_cookbook = all_products['30-lettuce-wrap-recipes-book-pdf'] -%}
  {%- if original_cookbook == blank -%}
    {%- assign original_cookbook = all_products['30-lettuce-wraps-cookbook'] -%}
  {%- endif -%}
  {%- if original_cookbook == blank -%}
    {%- assign original_cookbook = all_products['30-lettuce-wrap-recipes'] -%}
  {%- endif -%}
  {%- if original_cookbook == blank -%}
    {%- comment -%} Last resort: try to find by variant ID if product lookup fails {%- endcomment -%}
    {%- for product_item in collections.all.products -%}
      {%- for variant in product_item.variants -%}
        {%- if variant.id == 52664745394483 -%}
          {%- assign original_cookbook = product_item -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if original_cookbook != blank -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

<div class="product-upsell-bundle">
  <div class="upsell-container">
    <div class="upsell-badge">SPECIAL OFFER</div>
    
    <h3 class="upsell-title">Complete Your Collection!</h3>
    
    <div class="upsell-content">
      <div class="upsell-product">
        {%- if original_cookbook.featured_image -%}
          <img 
            src="{{ original_cookbook.featured_image | image_url: width: 300 }}" 
            srcset="{{ original_cookbook.featured_image | image_url: width: 300 }} 300w,
                    {{ original_cookbook.featured_image | image_url: width: 600 }} 600w"
            sizes="150px"
            alt="{{ original_cookbook.featured_image.alt | default: '30 Lettuce Wraps Cookbook' | escape }}" 
            class="upsell-image"
            loading="lazy"
            width="150"
            height="{{ 150 | divided_by: original_cookbook.featured_image.aspect_ratio | ceil }}"
          >
        {%- else -%}
          {%- comment -%} Fallback placeholder if product image not found {%- endcomment -%}
          <div class="upsell-image upsell-image-placeholder" style="width: 150px; height: 150px; background: #f0f0f0; border: 2px solid #005633; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.875rem;">
            Image
          </div>
        {%- endif -%}
        <div class="upsell-details">
          <h4>30 Lettuce Wraps Cookbook</h4>
          <p class="upsell-description">Get the original cookbook with 30 more recipes!</p>
          <div class="upsell-pricing">
            <span class="upsell-price-original">$9.99</span>
            <span class="upsell-price-bundle">$4.99</span>
            <span class="upsell-savings">Save $5!</span>
          </div>
        </div>
      </div>
      
      <div class="upsell-total">
        <p><strong>Bundle Total:</strong> $14.98 <span class="regular-price">(Regular $19.98)</span></p>
      </div>
      
      <button type="button" class="upsell-button" id="add-bundle-button">
        Add Both Cookbooks - $14.98
      </button>
      
      <p class="upsell-guarantee">✓ Instant digital delivery • ✓ 65 total recipes</p>
    </div>
  </div>
</div>

<script>
document.getElementById('add-bundle-button').addEventListener('click', async function() {
  const button = this;
  button.disabled = true;
  button.textContent = 'Adding to cart...';
  
  try {
    // Current product (NEW Lettuce Wraps and Sauce Cookbook)
    const currentProductVariantId = document.querySelector('[name="id"]').value;
    
    // Original 30 Lettuce Wraps Cookbook variant ID
    const originalCookbookVariantId = '52664745394483';
    
    // Add both items to cart
    const formData = {
      items: [
        {
          id: currentProductVariantId,
          quantity: 1
        },
        {
          id: originalCookbookVariantId,
          quantity: 1,
          properties: {
            '_bundle_discount': '$5.00 off'
          }
        }
      ]
    };
    
    const response = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });
    
    if (response.ok) {
      window.location.href = '/checkout';
    } else {
      throw new Error('Failed to add to cart');
    }
  } catch (error) {
    console.error('Error:', error);
    button.disabled = false;
    button.textContent = 'Add Both Cookbooks - $14.98';
    alert('Sorry, there was an error. Please try again.');
  }
});
</script>

{% endif %}

